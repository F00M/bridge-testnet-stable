<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bridge Stable Testnet ‚Äî iOS Fixed</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<style>
  :root{
    --bg1:#0e1510; --bg2:#000; 
    --card:#101910; --muted:#203520; --field:#0c150d;
    --acc1:#22c55e; --acc2:#16a34a; --txt:#e8f3e9; --sub:#a9c7af;
  }
  body{
    margin:0;
    background:linear-gradient(180deg,#0e1510,#091009);
    min-height:100vh;
    font-family:'Poppins',sans-serif;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:30px 12px;
    color:var(--txt);
  }
  .wrap{width:min(480px,95vw);}
  .card{
    padding:20px;
    border-radius:16px;
    border:1px solid var(--muted);
    background:rgba(0,0,0,0.35);
  }
  h2{text-align:center;color:var(--acc1);margin-top:0;}
  label{font-size:12px;color:var(--sub);}
  input{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:1px solid var(--muted);
    background:var(--field);
    color:#fff;
    margin-top:4px;
    font-size:14px;
  }
  button{
    width:100%;padding:12px;margin-top:10px;border:0;
    border-radius:10px;font-weight:700;
    background:linear-gradient(90deg,var(--acc1),var(--acc2));
    color:#06110a;
  }
  button.secondary{background:#223a23;color:#cfe9d4}
  pre{
    margin-top:14px;
    background:#0d150d;
    padding:14px;
    border-radius:10px;
    min-height:120px;
    border:1px solid #203520;
    font-size:12px;
    white-space:pre-wrap;
  }
  .hint{font-size:12px;color:#86efac;margin-top:4px}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h2>üåâ Stable Testnet Bridge (iPhone Fixed)</h2>

    <button id="btnConnect" class="secondary">üîå Connect Wallet</button>
    <div id="status" class="hint">Wallet: -</div>

    <hr>

    <h3>Bridge USDT0 ‚Üí Stable</h3>
    <label>Jumlah (USDT0)</label>
    <input id="amount" placeholder="contoh: 10">
    <div id="bridgeBalance" class="hint">Saldo USDT0: -</div>
    <button id="btnApprove">Approve</button>
    <button id="btnBridge">üöÄ Bridge Sekarang</button>

    <hr>

    <h3>Cek Delivery</h3>
    <label>TX Hash (Sepolia)</label>
    <input id="lzTx" placeholder="0x...">
    <button id="btnCheck">üîé Cek Status</button>
    <div class="hint">LayerZeroScan bisa delay 1‚Äì5 menit.</div>

    <hr>

    <h3>Unwrap (Stable)</h3>
    <label>Jumlah</label>
    <input id="unwrapAmount" placeholder="contoh: 10">
    <button id="btnUnwrap">Unwrap</button>
    <div id="uwBalances" class="hint">USDT0: - | gUSDT: -</div>

    <pre id="log">log siap...</pre>
  </div>
</div>

<script>
/* ======================================
   KONFIGURASI RESMI
====================================== */
const CFG = {
  STABLE : { id:2201, hex:"0x899", rpc:"https://stable-jsonrpc.testnet.chain0.dev"},
  SEPOLIA:{ id:11155111, hex:"0xaa36a7"},

  /* KONTRAK PENTING */
  USDT0   : "0xc4DCC311c028e341fd8602D8eB89c5de94625927",

  /* KONTRAK OFT-ASAL ‚Üí kontrak send() di Sepolia
     Iki diisi alamat sing mas pakai tx kemarin:
  */
  SRC_OFT : "0xc099cD946d5efCC35A99D64E808c1430cEf08126",

  /* KONTRAK OFT TUJUAN (RESMI) */
  DST_OFT : "0x779Ded0c9e1022225f8E0630b35a9b54bE713736",

  /* Wrapper Stable (tetep sama) */
  WRAPPER : "0xcAB8F3ed8528655E0C2fad1C504c6CfEccf50B90",

  srcEid:30101,
  dstEid:40374
};

/* ======================================
   ABI
====================================== */
const ERC20_ABI = [
  "function approve(address,uint256) returns(bool)",
  "function balanceOf(address) view returns(uint256)"
];
const OFT_ABI = [
  "function quoteSend((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),bool) view returns(uint256,uint256)",
  "function send((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),(uint256,uint256),address) payable"
];
const WRAP_ABI = ["function depositTo(address,uint256)"];

/* ======================================
   HELPERS
====================================== */
const $ = id => document.getElementById(id);
const log = m => { $("log").textContent += "\n"+m; };

function toBytes32(addr){
  const c = ethers.utils.getAddress(addr);
  return "0x"+c.slice(2).padStart(64,"0");
}
function extraOptions(){
  const gas = ethers.BigNumber.from("300000");
  const nativeCap = ethers.utils.parseEther("0.001");
  const gasHex = ethers.utils.hexZeroPad(gas.toHexString(), 4).slice(2);
  const capHex = ethers.utils.hexZeroPad(nativeCap.toHexString(), 16).slice(2);
  return "0x000301001a"+gasHex+capHex;
}

function safeFee(f){
  if(ethers.BigNumber.isBigNumber(f)) return f;
  if(f?.nativeFee) return ethers.BigNumber.from(f.nativeFee);
  if(f?._hex) return ethers.BigNumber.from(f._hex);
  return ethers.BigNumber.from(f);
}

/* ======================================
   CONNECT (IOS FIXED)
====================================== */
let provider, signer, me;

async function connect(){
  try{
    if(!window.ethereum) throw new Error("Gunakan MetaMask / OKX Wallet iOS.");

    await window.ethereum.request({ method:"eth_requestAccounts" });

    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    signer   = provider.getSigner();
    me       = await signer.getAddress();

    const net = await provider.getNetwork();

    $("status").textContent = `Wallet: ${me.slice(0,6)}‚Ä¶${me.slice(-4)} | Chain: ${net.chainId}`;
    log(`Connected as ${me}`);
    
    refreshBridgeBalance(); 
    refreshUwBalances();
  }catch(e){
    log("‚ùå Connect error: "+e.message);
  }
}

/* ======================================
   BALANCE REFRESH
====================================== */
async function refreshBridgeBalance(){
  try{
    const net = await provider.getNetwork();
    if(net.chainId !== CFG.SEPOLIA.id){
      $("bridgeBalance").textContent="Saldo USDT0: (switch ke Sepolia)";
      return;
    }
    const erc = new ethers.Contract(CFG.USDT0, ERC20_ABI, provider);
    const bal = await erc.balanceOf(me);
    $("bridgeBalance").textContent = "Saldo USDT0: "+ethers.utils.formatUnits(bal,6);
  }catch{}
}

async function refreshUwBalances(){
  try{
    const net = await provider.getNetwork();
    if(net.chainId !== CFG.STABLE.id){
      $("uwBalances").textContent="USDT0: (switch ke Stable) | gUSDT: -";
      return;
    }
    const erc = new ethers.Contract(CFG.USDT0, ERC20_ABI, provider);
    const bal = await erc.balanceOf(me);
    $("uwBalances").textContent = "USDT0: "+ethers.utils.formatUnits(bal,6)+" | gUSDT: -";
  }catch{}
}

/* ======================================
   APPROVE
====================================== */
async function approve(){
  try{
    const net = await provider.getNetwork();
    if(net.chainId !== CFG.SEPOLIA.id){
      await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{chainId:CFG.SEPOLIA.hex}] });
    }
    const amt = $("amount").value.trim();
    const val = ethers.utils.parseUnits(amt,6);

    log("Approve...");
    const erc = new ethers.Contract(CFG.USDT0, ERC20_ABI, signer);
    const tx = await erc.approve(CFG.SRC_OFT, val);
    log("TX: "+tx.hash);
    await tx.wait();
    log("Approve sukses.");
  }catch(e){ log("Approve error: "+e.message);}
}

/* ======================================
   BRIDGE
====================================== */
async function bridge(){
  try{
    const net = await provider.getNetwork();
    if(net.chainId !== CFG.SEPOLIA.id){
      await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{chainId:CFG.SEPOLIA.hex}] });
    }

    const amt = $("amount").value.trim();
    const amountLD = ethers.utils.parseUnits(amt,6);

    const to32 = toBytes32(me);
    const oft = new ethers.Contract(CFG.SRC_OFT, OFT_ABI, signer);
    const extra = extraOptions();

    const params = [CFG.dstEid, to32, amountLD, amountLD, extra, "0x","0x"];

    log("Estimating fee...");
    const feeRaw = await oft.quoteSend(params, false);
    const nativeFee = safeFee(feeRaw);
    log("Fee: "+ethers.utils.formatEther(nativeFee));

    log("Sending...");
    const tx = await oft.send(params, [nativeFee,0], me, {
      value:nativeFee,
      gasLimit:900000
    });
    log("TX: "+tx.hash);
    await tx.wait();
    log("Bridge TX terkirim. Tunggu relayer LayerZero.");
  }catch(e){ log("Bridge error: "+e.message);}
}

/* ======================================
   CHECK STATUS
====================================== */
async function checkStatus(){
  try{
    const h = $("lzTx").value.trim();
    if(!/^0x[0-9a-fA-F]{64}$/.test(h)) return log("TX hash tidak valid");

    log("Cek LayerZeroScan...");
    const url = "https://testnet.layerzeroscan.com/tx/"+h;
    log("Buka manual: "+url);
    window.open(url,"_blank");
  }catch(e){ log("Status error: "+e.message);}
}

/* ======================================
   UNWRAP
====================================== */
async function unwrap(){
  try{
    const net = await provider.getNetwork();
    if(net.chainId !== CFG.STABLE.id){
      await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{chainId:CFG.STABLE.hex}] });
    }

    const amt = $("unwrapAmount").value.trim();
    const val = ethers.utils.parseUnits(amt,6);

    const erc = new ethers.Contract(CFG.USDT0, ERC20_ABI, signer);
    const bal = await erc.balanceOf(me);
    if(bal.lt(val)) return log("Saldo tidak cukup.");

    log("Approve wrapper...");
    const txA = await erc.approve(CFG.WRAPPER, val);
    log("TX: "+txA.hash);
    await txA.wait();

    const wrap = new ethers.Contract(CFG.WRAPPER, WRAP_ABI, signer);
    const txB = await wrap.depositTo(me, val, {gasLimit:400000});
    log("TX: "+txB.hash);
    await txB.wait();

    log("Unwrap sukses.");
  }catch(e){ log("Unwrap error: "+e.message);}
}

/* ======================================
   BIND BUTTON
====================================== */
$("btnConnect").onclick = connect;
$("btnApprove").onclick = approve;
$("btnBridge").onclick  = bridge;
$("btnCheck").onclick   = checkStatus;
$("btnUnwrap").onclick  = unwrap;
</script>

</body>
</html>
